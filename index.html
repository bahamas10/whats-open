<!DOCTYPE html>
<html>
	<head>
		<title>What's Open Now?</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta charset="utf-8">
		<style>
			html, body, #map-canvas {
				margin: 0;
				padding: 0;
				height: 100%;
				font-family: Helvetica, sans-serif;
			}
			#buttons {
				position: absolute;
				right: 0;
				top: 50px;
				text-align: right;
			}
			#buttons button {
				font-size: 14pt;
			}
			#about {
				padding: 2px;
				position: fixed;
				display: none;
				bottom: 0;
				left: 0;
				width: 300px;
				font-size: 9pt;
				background-color: #edd;
			}
			@media only screen and (max-width: 767px) {
				#buttons button { font-size: 12pt; }
			}
		</style>
		<link href="https://developers.google.com/maps/documentation/javascript/examples/default.css" rel="stylesheet">
		<link href="lib/libnotify.css" rel="stylesheet">
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
		<script type="text/javascript" src="lib/humane.min.js"></script>
		<script>
			var map;
			var service;
			var infowindow;
			var about;
			var markers = [];

			if (typeof console === 'undefined') console = {};
			if (typeof console.log === 'undefined') console.log = function() {};

			function initialize() {
				// buffalo ny!
				var initiallocation = new google.maps.LatLng(42.8864, -78.8786);
				var mapOptions = {
					zoom: 14,
					center: initiallocation,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
				service = new google.maps.places.PlacesService(map);
				infowindow = new google.maps.InfoWindow();
				about = document.getElementById('about');
				google.maps.event.addListener(map, 'click', infowindow.close.bind(infowindow));
				findme();
			}

			function createmarkers(places) {
				var bounds = new google.maps.LatLngBounds();

				for (var i = 0; i < markers.length; i++) {
					markers[i].setMap(null);
				}

				for (var i = 0, place; place = places[i]; i++) {
					var image = {
						url: place.icon,
						size: new google.maps.Size(71, 71),
						origin: new google.maps.Point(0, 0),
						anchor: new google.maps.Point(17, 34),
						scaledSize: new google.maps.Size(25, 25)
					};

					var marker = new google.maps.Marker({
						map: map,
						reference: place.reference,
						icon: image,
						title: place.name,
						position: place.geometry.location
					});
					markers.push(marker);
					google.maps.event.addListener(marker, 'click', function() {
						var marker = this;

						service.getDetails({
							reference : marker.get('reference')
							}, function(result) {
							if (!result) return;
							var title = marker.get('title') || '';
							var html = '<b>' + title + '</b><br>';

							marker.set('url', result.url);
							var url = marker.get('url');
							html += '<small>';
							if (url) html += '<a href="' + url  + '" target=_blank>more info &raquo;</a><br>';
							if (result.formatted_address) html += result.formatted_address + '<br>';
							if (result.formatted_phone_number) html += result.formatted_phone_number + '<br>';
							var periods = result.opening_hours && result.opening_hours.periods && result.opening_hours.periods;
							if (periods) {
								var now = Date.now();
								var deltas = [];
								for (var i = 0; i < periods.length; i++) {
									var period = periods[i];
									var delta = (period.close.nextDate - now);
									deltas.push(delta);
								}

								var delta = Math.min.apply(Math, deltas);
								var d = new Date(now + delta);
								delta = delta / 60 / 1000;
								var hours = Math.floor(delta / 60);
								var minutes = Math.round(delta - (hours * 60));
								html += '<br>Closes at ' + formatAMPM(d) + '<br>';
								html += hours ? (hours + ' hours, ') : '';
								html +=  minutes + ' minutes from now<br>';
							}
							html += '</small>';

							infowindow.setContent(html);
							infowindow.open(map, marker);
						});
					});
					bounds.extend(place.geometry.location);
				}
				//map.fitBounds(bounds);
			}
			google.maps.event.addDomListener(window, 'load', initialize);

			function refresh(t) {
				var request = {
					bounds: map.getBounds(),
					location: map.getCenter(),
					radius: '1000',
					openNow: true
				};

				switch (t) {
					case 'food':
						request.types = ['food'];
						break;
					default:
						break;
				}
				service.nearbySearch(request, function(results, status, pagination) {
					if (status !== google.maps.places.PlacesServiceStatus.OK) {
						return;
					}
					var s = results.length;
					if (s === 20) s += ' (max)';
					humane.log(s + ' results found');
					createmarkers(results);
				});
			}

			function toggleabout() {
				about.style.display = about.style.display === 'block' ? 'none' : 'block';
			}

			/* http://stackoverflow.com/questions/8888491/how-do-you-display-javascript-datetime-in-12-hour-am-pm-format */
			function formatAMPM(date) {
				var hours = date.getHours();
				var minutes = date.getMinutes();
				var ampm = hours >= 12 ? 'pm' : 'am';
				hours = hours % 12;
				hours = hours ? hours : 12; // the hour '0' should be '12'
				minutes = minutes < 10 ? '0'+minutes : minutes;
				var strTime = hours + ':' + minutes + ' ' + ampm;
				return strTime;
			}

			function findme() {
				if (navigator.geolocation) {
					humane.log('locating you...');
					navigator.geolocation.getCurrentPosition(function(position) {
						map.setCenter(new google.maps.LatLng(position.coords.latitude,position.coords.longitude));
					}, function() {
					humane.log('error locating you :(');
					});
				} else {
					humane.log('not supported');
				}
			}

		</script>
	</head>
	<body>
		<div id="map-canvas"></div>
		<div id="buttons">
			<button id="toggle-about" onclick="toggleabout()">About</button><br>
			<button onclick="findme()">Find Me</button><br><br><br>
			<button onclick="refresh()">All</button><br>
			<button onclick="refresh('food')">Food</button><br>
		</div>
		<div id="about">
			What's Open is a free service that uses Google Maps to show what places are around you are currently open.<br><br>
			The idea is that at 4 in the morning you want to go somewhere to get food, but you don't know what is open at that hour.
			What's Open will find all places around you that are currently open, and tell you how long you have until they close.<br><br>
			You are limited to 20 search results at a time, so if you find you are only seeing 20 search results, try zooming in and searching again
			by hitting the "all" or "food" buttons on the right hand side.<br><br>
			Created by: <a href="http://www.daveeddy.com" target="new">Dave Eddy</a><br>
			Idea by: <a href="http://skyeillustration.com" target="new">Skye Sawyer</a><br>
			OpenSourced on: <a href="https://www.github.com/bahamas10/whats-open" target="new">GitHub</a> (MIT License)<br>
		</div>
	</body>
</html>
